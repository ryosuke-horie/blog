---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";

type Post = {
    type: "blog" | "external";
    slug: string;
    title: string;
    pubDate: Date;
    url?: string;
    platform?: "zenn" | "qiita" | "speakerdeck" | "other";
};

const blogPosts = await getCollection("blog");
const externalPosts = await getCollection("external");

const allPosts: Post[] = [
    ...blogPosts.map((post) => ({
        type: "blog" as const,
        slug: post.slug,
        title: post.data.title,
        pubDate: post.data.pubDate,
    })),
    ...externalPosts.map((post) => ({
        type: "external" as const,
        slug: post.slug,
        title: post.data.title,
        pubDate: post.data.pubDate,
        url: post.data.url,
        platform: post.data.platform,
    })),
].sort((a, b) => b.pubDate.valueOf() - a.pubDate.valueOf());

// 年ごとにグループ化
const postsByYear = allPosts.reduce(
    (acc, post) => {
        const year = post.pubDate.getFullYear();
        if (!acc[year]) acc[year] = [];
        acc[year].push(post);
        return acc;
    },
    {} as Record<number, Post[]>,
);

const years = Object.keys(postsByYear)
    .map(Number)
    .sort((a, b) => b - a);

// 日付をフォーマットする関数
const formatDate = (date: Date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
};

// プラットフォーム表示名
const platformLabels: Record<string, string> = {
    zenn: "Zenn",
    qiita: "Qiita",
    speakerdeck: "SpeakerDeck",
    other: "External",
};
---

<!doctype html>
<html lang="ja">
    <head>
        <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
        <style>
            main {
                width: 960px;
            }
            .year-section {
                margin-bottom: 2rem;
                border-bottom: 1px solid rgb(var(--gray-light));
            }
            .year-heading {
                font-size: 1.5rem;
                font-weight: bold;
                margin: 0 0 1rem 0;
                padding: 0.5rem 0;
                color: rgb(var(--black));
                cursor: pointer;
                list-style: none;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .year-heading::-webkit-details-marker {
                display: none;
            }
            .year-heading::before {
                content: "";
                display: inline-block;
                border-top: 5px solid transparent;
                border-bottom: 5px solid transparent;
                border-left: 6px solid currentColor;
                transition: transform 0.2s ease;
            }
            .year-section[open] > .year-heading::before {
                transform: rotate(90deg);
            }
            .year-heading:hover {
                color: rgb(var(--accent));
            }
            .post-count {
                font-size: 0.875rem;
                font-weight: normal;
                color: rgb(var(--gray));
            }
            ul {
                list-style-type: none;
                margin: 0;
                padding: 0;
            }
            ul li {
                margin-bottom: 0.5rem;
            }
            ul li a {
                display: inline-block;
                text-decoration: none;
                color: rgb(var(--black));
                transition: color 0.2s ease;
            }
            ul li a:hover {
                color: rgb(var(--accent));
            }
            .date {
                color: rgb(var(--gray));
                font-family: monospace;
                margin-right: 1rem;
            }
            .title {
                color: inherit;
            }
            .platform-tag {
                font-size: 0.75rem;
                padding: 0.125rem 0.375rem;
                border-radius: 3px;
                margin-left: 0.5rem;
                font-weight: 500;
            }
            .platform-zenn {
                background-color: #3ea8ff;
                color: white;
            }
            .platform-qiita {
                background-color: #55c500;
                color: white;
            }
            .platform-speakerdeck {
                background-color: #009287;
                color: white;
            }
            .platform-other {
                background-color: rgb(var(--gray));
                color: white;
            }
            .external-icon {
                font-size: 0.75rem;
                margin-left: 0.25rem;
                opacity: 0.7;
            }
            @media (max-width: 720px) {
                .year-section {
                    margin-bottom: 1.5rem;
                }
                ul li {
                    margin-bottom: 0.75rem;
                }
                ul li a {
                    display: block;
                }
                .date {
                    display: block;
                    margin-bottom: 0.25rem;
                }
            }
        </style>
    </head>
    <body>
        <Header />
        <main>
            {
                years.map((year) => (
                    <details class="year-section" open>
                        <summary class="year-heading">
                            {year}
                            <span class="post-count">({postsByYear[year].length}件)</span>
                        </summary>
                        <ul>
                            {postsByYear[year].map((post) => (
                                <li>
                                    {post.type === "blog" ? (
                                        <a href={`/${post.slug}/`}>
                                            <span class="date">
                                                {formatDate(post.pubDate)}
                                            </span>
                                            <span class="title">
                                                {post.title}
                                            </span>
                                        </a>
                                    ) : (
                                        <a
                                            href={post.url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                        >
                                            <span class="date">
                                                {formatDate(post.pubDate)}
                                            </span>
                                            <span class="title">
                                                {post.title}
                                            </span>
                                            <span class="external-icon">↗</span>
                                            {post.platform && (
                                                <span
                                                    class={`platform-tag platform-${post.platform}`}
                                                >
                                                    {platformLabels[post.platform]}
                                                </span>
                                            )}
                                        </a>
                                    )}
                                </li>
                            ))}
                        </ul>
                    </details>
                ))
            }
        </main>
        <Footer />
    </body>
</html>
