---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 年ごとにグループ化
const postsByYear = posts.reduce(
    (acc, post) => {
        const year = post.data.pubDate.getFullYear();
        if (!acc[year]) acc[year] = [];
        acc[year].push(post);
        return acc;
    },
    {} as Record<number, typeof posts>,
);

const years = Object.keys(postsByYear)
    .map(Number)
    .sort((a, b) => b - a);

// 日付をフォーマットする関数
const formatDate = (date: Date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
};
---

<!doctype html>
<html lang="ja">
    <head>
        <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
        <style>
            main {
                width: 960px;
            }
            .year-section {
                margin-bottom: 2rem;
            }
            .year-heading {
                font-size: 1.5rem;
                font-weight: bold;
                margin: 0 0 1rem 0;
                color: rgb(var(--black));
                border-bottom: 1px solid rgb(var(--gray-light));
                padding-bottom: 0.5rem;
            }
            ul {
                list-style-type: none;
                margin: 0;
                padding: 0;
            }
            ul li {
                margin-bottom: 0.5rem;
            }
            ul li a {
                display: inline-block;
                text-decoration: none;
                color: rgb(var(--black));
                transition: color 0.2s ease;
            }
            ul li a:hover {
                color: rgb(var(--accent));
            }
            .date {
                color: rgb(var(--gray));
                font-family: monospace;
                margin-right: 1rem;
            }
            .title {
                color: inherit;
            }
            @media (max-width: 720px) {
                .year-section {
                    margin-bottom: 1.5rem;
                }
                ul li {
                    margin-bottom: 0.75rem;
                }
                ul li a {
                    display: block;
                }
                .date {
                    display: block;
                    margin-bottom: 0.25rem;
                }
            }
        </style>
    </head>
    <body>
        <Header />
        <main>
            {
                years.map((year) => (
                    <section class="year-section">
                        <h2 class="year-heading">{year}</h2>
                        <ul>
                            {postsByYear[year].map((post) => (
                                <li>
                                    <a href={`/${post.slug}/`}>
                                        <span class="date">
                                            {formatDate(post.data.pubDate)}
                                        </span>
                                        <span class="title">
                                            {post.data.title}
                                        </span>
                                    </a>
                                </li>
                            ))}
                        </ul>
                    </section>
                ))
            }
        </main>
        <Footer />
    </body>
</html>
